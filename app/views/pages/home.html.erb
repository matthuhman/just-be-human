<head>
  <title>Simple Map</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
</head>
  <body>
    <div class="home-page">
      <aside class="home-page-aside">
        <div class="d-flex flex-column align-items-center homepage-header">
          <h3>Problems Near Me - Currently active zip code: <%= @geopoint.zip %></h3>
        </div>
        <% @problems.each do |problem| %>
          <div class="problem-row">
            <h5><%= problem.title %></h5>
            <p><%= problem.description %></p>
            <p><strong>Due: </strong><%= problem.target_completion_date %></p>
            <p><strong>Created by: </strong><%= problem.user.username %></p>
            <div class="d-flex flew-row justify-content-around">
              <%= link_to 'Show', problem, class: 'problem-link' %>
              <% if current_user == problem.user %>
                <%= link_to 'Edit', edit_problem_path(problem), class: 'problem-link'  %>
                <%= link_to 'Delete', problem, method: :delete, data: { confirm: 'Are you sure?' }, class: 'problem-link'  %>
              <% end %>
            </div>
          </div>
        <% end %>
      </aside>
      <div id="map"></div>
    </div>
  <script>
    var map;
    // var assignListener = function(markerObj, infoWindowObj){
    //   console.log('Clicked on a marker')
    //   return function() {
    //          infoWindowObj.open(map, markerObj);
    //           };
    // };
    function initMap()
    {
      map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: <%= @geopoint.latitude %>, lng: <%= @geopoint.longitude %>},
        zoom: 14,
        streetViewControl: false,
        mapTypeControl: false
      });

      var json = <%= raw @problems.map.to_json {|problem|}.html_safe %>;

      var infoWindow = new google.maps.InfoWindow();

      for (var i = 0, length = json.length; i < length; i++)
      {
        var data = json[i],
          LatLng = {lat: parseFloat(data.latitude), lng: parseFloat(data.longitude)};
          // @MATT -- fix the parse float issue


        data.contentString =
          '<div id="content">' +
            '<div id="siteNotice"></div>' +
            '<h2 id="marker_title" class="marker_title">' + data.title + '</h2>' +
            '<h4 id="marker_participants" class="marker_participants">Participant status:' + data.volunteer_count + "/" + data.volunteers_required + "</h4>" +
            '<h5 id="marker_followers" class="marker_followers">Followers: ' + data.follower_count + "</h5>" +
            '<h5 id="marker_category" class="marker_category">Category: ' + data.category_title + ' -- Subcategory: ' + data.subcategory_title + '</h5>' +
            '<h6 id="marker_link" class="marker_link"><a href="/problems/' + data.id + '">See Problem Details</a>' +
          '</div>';

        var marker = new google.maps.Marker({
          position: LatLng,
          map: map,
          animation: google.maps.Animation.DROP
        });


        (function (marker, data) {
          google.maps.event.addListener(marker, "click", function (e) {
            infoWindow.setContent(data.contentString);
            infoWindow.open(map, marker);
          });
        }) (marker, data);

        //marker.addListener('click', assignListener(marker, infoWindow));
      }
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvo5jgtwJAlgCwAA9_5v_pUgphXxe9ntY&callback=initMap"
  async defer>
  </script>
</body>
