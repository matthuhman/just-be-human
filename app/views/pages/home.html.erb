


<br/>


<h4>Problems Near Me - Currently active zip code: <%= current_user.zip %></h4>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 80%;
        width: 80%;
        margin: auto;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <% current_geopoint = Geopoint.find_by(zip: current_user.zip) %>
    <div id="map"></div>
    <script>
      var map;
      var assignListener = function(markerObj, infoWindowObj){
        return function() {
               infoWindowObj.open(map, markerObj);
                };
      };
      function initMap() 
      {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: <%= current_geopoint.latitude %>, lng: <%= current_geopoint.longitude %>},
          zoom: 14,
          streetViewControl: false,
          mapTypeControl: false
        });

        var json = <%= raw @problems.map.to_json {|problem|}.html_safe %>;

        for (var i = 0, length = json.length; i < length; i++) 
        {
          var data = json[i],
            LatLng = {lat: data.latitude, lng: data.longitude};

          var contentString = 
            '<div id="content">' +
              '<div id="siteNotice"></div>' +
              '<h2 id="marker_title" class="marker_title">' + data.title + '</h2>' +
              '<h4 id="marker_participants" class="marker_participants">Participant status:' + data.participant_count + "/" + data.participants_required + "</h4>" + 
              '<h5 id="marker_followers" class="marker_followers">Followers: ' + data.follower_count + "</h5>" +
              '<h5 id="marker_category" class="marker_category">Category: ' + data.category + ' -- Subcategory: ' + data.subcategory + '</h5>' +
              '<h6 id="marker_link" class="marker_link"><a href="/problems/' + data.id + '">See Problem Details</a>' +
            '</div>';

          console.log(contentString);

          var infoWindow = new google.maps.InfoWindow({
            content: contentString
          });

          var marker = new google.maps.Marker({
            position: LatLng,
            map: map,
            animation: google.maps.Animation.DROP
          });

          marker.addListener('click', assignListener(marker, infoWindow));
        }
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDvo5jgtwJAlgCwAA9_5v_pUgphXxe9ntY&callback=initMap"
    async defer></script>
  </body>

<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>Description</th>
      <th>Target completion date</th>
      <th>User</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @problems.each do |problem| %>
      <tr>
        <td><%= problem.title %></td>
        <td><%= problem.description %></td>
        <td><%= problem.target_completion_date %></td>
        <td><%= problem.user.username %></td>
        <td><%= link_to 'Show', problem %></td>
        <% if current_user == problem.user %>
        <td><%= link_to 'Edit', edit_problem_path(problem) %></td>
        <td><%= link_to 'Delete', problem, method: :delete, data: { confirm: 'Are you sure?' } %></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>


<% if current_user %>
  <div class="my-problems">
  <h4>My Problems</h4>
    <% @roles.each do |role| %>
      <p>Problem Name: <%= role.problem.title %></p>
      <p>Problem Role: <%= role.title %></p>
    <% end %>
  </div>
<% end %>

<br>
<br>
<h4> Links </h4>
<br>

<%= link_to 'New Problem', new_problem_path %>

<% if current_user %>
<%= link_to 'Sign Out', destroy_user_session_path, method: :delete %>
<% else %>
<%= link_to 'Sign Up', new_user_registration_path %>
<%= link_to 'Sign In', new_user_session_path %>
<% end %>


<%= link_to 'Problems', problems_path %>


